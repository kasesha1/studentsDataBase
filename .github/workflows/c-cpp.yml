name: C/C++ CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up GCC
      run: |
        sudo apt-get update
        sudo apt-get install -y g++
    
    - name: Build
      run: make
    
    - name: Run tests with timeout
      run: |
        OUTPUT=$(timeout 15s bash -c 'echo -e "4\n0" | ./student_db' 2>&1 || true)
        
        echo "=== Вывод программы ==="
        echo "$OUTPUT"
        echo "=== Конец вывода ==="
        
        if echo "$OUTPUT" | grep -q "ВСЕ.*ТЕСТОВ ПРОЙДЕНЫ УСПЕШНО"; then
          echo "✔ Все тесты прошли успешно!"
        else
          echo "✘ Тесты не прошли или не завершились"
          exit 1
        fi
